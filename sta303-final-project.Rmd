---
title: "Report title"
subtitle: "Subtitle that indicates findings"
author: "Report prepared for MINGAR by [MANGO]"
date: 2022-04-07
lang: "en"
output:
  pdf_document:
    template: report.tex
    toc: true
    toc_depth: 2
    
titlepage: true
titlepage-color: "6C3082"
titlepage-text-color: "FFFFFF"
titlepage-rule-color: "FFFFFF"
titlepage-rule-height: 2
---

```{r, message = FALSE, echo=FALSE, warning = FALSE}
library(tidyverse)
library(lme4)
library(rvest)
library(polite)
library(lmtest)
library(wesanderson)
library(ggplot2)
library(gplots)
library(ggmap)
library(maps)
library(mapdata)
library(leaflet)
library(plotly)
library(RColorBrewer)
library(ggpubr)

# this should suppress all code and messages
knitr::opts_chunk$set(include=FALSE)
```

# General comments (you can delete this section)

*Before making any changes, knit this Rmd to PDF and change the name of the PDf to something like 'original-instructions.pdf', or whatever you like (it is just for your reference).. Then you can delete this section and if you want to check what it said, just open the other PDF. You don't HAVE to use this particular template, but you DO need to write you report in RMarkdown and include a cover page.*

*The cover page must be a single stand alone page and have:*

-   *A title and subtitle (that indicate your findings)*
-   *"Report prepared for MINGAR by" your company name*
-   *Date (assessment submission date is fine)*

*You can change the colour of this cover to any colour you would like by replacing 6C3082 in the YAML above (`titlepage-color:`) to another hex code. You could use this tool to help you:* <https://htmlcolorcodes.com/color-picker/>

*Note: There should NOT be a table of contents on the cover page. It should look like a cover.*

\newpage

# Executive summary

*Guidelines for the executive summary:*

-   *No more than two pages*
-   *Language is appropriate for a non-technical audience*
-   *Bullet points are used where appropriate*
-   *A small number of key visualizations and/or tables are included*
-   *All research questions are addressed*

*The [module 4 writing prompt](https://sta303-bolton.github.io/sta303-w22-courseguide/knowledge-basket-writing-and-peer-feedback.html#module-4-writing-task) provides some tips and information about writing executive summaries.*

\newpage

# Technical report

*This part of the report is much more comprehensive than the executive summary. The audience is statistics/data-minded people, but you should NOT include code or unformatted R output here.*

## Introduction

*Provide a brief introduction to your report and outline what the report will cover. This section is valuable for setting scope and expectations.*

### Research questions

-   How do the demographic for the traditional lines compare with that of the "Active and "Advance" lines?

-   How does skin color (identified by individual's emoji modifiers) affect the number of quality flags that MINGAR devices report during a sleep tracking session?

-   What are the main differences between different lines of the device?

## What is the demographic of different lines of product?

### Location of customers

To create the plot that demonstrate the location of users in different production line, we combined the user dataset with web script Census Canada Postal Code Conversion dataset by postcode. We can therefore generate the province that the user belongs to by extracting the first two digit of CSDuid (Census subdivision unique identifier) from the Census dataset.

In Figure 1, the size of the bubble is proportional to percentage of customers in each province in that line and the position of each bubble represents the latitude and longtitude of that province. From the plot, we can notice that Ontario has the most users in all four lines. In Active line and Advance line, The users in Quebec is slightly less than ones in Ontario, but in Run line, the number of users in Alberta exceeds the number of users in Quebec. From the result, we are able to see where the target customers is located for product in different lines.

```{r}
device_cust <-read.csv("./data/device_cust.csv")
```

```{r}
province <- c(10, 11, 12, 13, 24, 35, 46, 47, 48, 59, 60, 61, 62)
province_name <- c("Newfoundland and Labrador", "Prince Edward Island","Nova Scotia", "New Brunswick", "Quebec", "Ontario", "Manitoba", "Saskatchewan", "Alberta", "British Columbia", "Yukon", "Northwest Territories", "Nunavut")
latitude <- c(53.5, 46, 45, 46.498390, 53, 50, 56.415211, 55, 55, 53.726669, 64, 62.135189, 70.453262)
longtitude <- c(-60, -63, -63, -66.159668, -70, -85,-98.739075, -106, -115, -127.647621, -135, -122.792473, -86.798981)
canada_pro<- data.frame(province = province, province_name = province_name, latitude=latitude,longtitude= longtitude)

device_cust$province <- substr(device_cust$CSDuid,1,2)
device_cust <- merge(device_cust, canada_pro, by="province")
province_data <- device_cust %>% group_by(province, line) %>% summarise(num = n(), province_name, latitude, longtitude) %>% unique()

province_data_active <- province_data[province_data$line == "Active",]

province_data_advance <- province_data[province_data$line == "Advance",]
province_data_run <- province_data[province_data$line == "Run",]
province_data_idol <- province_data[province_data$line == "iDOL",]
```

```{r include=F}
# province_data %>% 
#   plot_ly(x=~longtitude, y=~latitude, type="scatter", mode = "hover", color= ~province_name, size=~num, sizes = c(20, 200),  #marker=list(sizemode="diameter", opacity=0.5)) %>% layout(title="Active")
# 
# province_data_advance %>%
#   plot_ly(x=~longtitude, y=~latitude, type="scatter", mode = "hover", color= ~province_name, size=~num, sizes = c(20, 200),  marker=list(sizemode="diameter", opacity=0.5)) %>% layout(title="Advance")
# 
# province_data_run %>% 
#   plot_ly(x=~longtitude, y=~latitude, type="scatter", mode = "hover", color= ~province_name, size=~num, sizes = c(20, 200),  marker=list(sizemode="diameter", opacity=0.5))%>% layout(title="Run")
# 
# province_data_idol %>%
#   plot_ly(x=~longtitude, y=~latitude, type="scatter", mode = "hover", color= ~province_name, size=~num, sizes = c(20, 200),  marker=list(sizemode="diameter", opacity=0.5))%>% layout(title="iDOL")

```

![Customer location by device line](./data/province_line.png)

### Age of customers

```{r fig.cap="Age of customer by device line", include=T, echo=F, fig.height=3}

device_cust %>% ggplot(aes(x = age, fill=line)) + geom_histogram(bins = 30) +  facet_wrap("line") + theme_minimal() + scale_fill_manual(values = wes_palette("Moonrise3"))+ theme(legend.position="none")
```

To get a sense of how the age of customers is distributed in different lines, we created a histogram plot of the Age of customer by device line. In the plot above, we can see that Advance, Run and iDOL line have a similar distribution that is slightly right-skewed and there is a bimodal distribution in Active line. We deside to use Kruskal Wallis test since the response do not have a normal distribution and there are more than two categories for the independent variable, `line`.

#### Assumption Checking

-   It satisfies the assumptions that there are two or more levels in the independent variable `line`, the dependent variable,`age`, is on a ratio scale and the observations are independent.

-   The fourth assumption is that all groups should have same shape distributions. In our case, three of the groups have same shape distribution, while Active line have a bimodal distribution, which may be caused by the lack of data. It is a limitation in the model assumption checking process.

#### Kruskal Wallis Test

After running the Kruskal Wallis Test, we get a p-value of $5.206^{-13}$. It is smaller than the significant level of 0.05, thus we can conclude that the customers in the four lines do not have the same median age.

```{r}
kruskal.test(age ~ line, data = device_cust)
```

### Gender of customers

To test whether the customers gender in new and traditional lines are different. We created a new variable `line_binary` which have a value `new` for active and advance line, and `old` for other lines.From the bar plot below, we can notice that there are more female customers in both new line and old lines. Since there are more females in either case, we created a new variable `sex_binary` which have a value 1 for female and 0 for other genders, in order to do the two sample t-test.

```{r fig.cap="Sex of customer by device line", include=T, echo=F, fig.height=2}
device_cust$line_binary <- ifelse(device_cust$line %in% c("Advance", "Active"), "new", "old")
device_cust %>% ggplot(aes(x = sex, fill=line_binary)) + geom_bar() +  facet_wrap("line_binary") + theme_minimal() + scale_fill_manual(values = wes_palette("Moonrise3"))+ theme(legend.position="none")
```

#### Two Sample t-test

We conducted a two sample t-test on it. The mean in group `new` and group `old` is 0.578 and 0.586 respectively. Which indicates that there are approximatly 58% customers that are female in all lines. Since the p-value is 0.2598, we do not reject the hypothesis that the difference in mean gender equal to 0 between two groups of lines. The result indicates that the gender of customers do not very for old and new lines.

```{r}
device_cust$sex_binary <-  ifelse(device_cust$sex == "Female", 1, 0)
t.test(sex_binary~ line_binary, data = device_cust, var.equal = TRUE)
```

### Income of customers

```{r fig.cap="Household income of customer by device line", include=T, echo=F, fig.height=2}
income <-  read.csv("./data/median_income.csv")

group_income <- inner_join(device_cust, income, by = "CSDuid") %>% select(c("line","line_binary", "hhld_median_inc"))
group_income %>% ggplot(aes(x= hhld_median_inc, fill = line_binary)) + geom_histogram(bins = 30) + facet_wrap("line_binary") + theme_minimal() + scale_fill_manual(values = wes_palette("Moonrise3")) + theme(legend.position="none") + labs(x="household income")

```
```{r}
t.test(hhld_median_inc~ line_binary, data = group_income, var.equal = TRUE)
```

#### Two Sample t-test

From the two sample t-test, the mean income in group `new` and group `old` is 68815.47 and 73166.18 respectively with a p-value of $2.2^{-16}$. Thus, we reject the hypothesis that the two groups have the same mean in income and we can see that the customers who buy products from the new line have around 4000 less mean income than those who buy from the old line.

## How does skin color affect the accuracy of wearable devices?
### Data Manipulation
The dataset "race_sleep_data" is obtained through combining the customer profiles, the sleep tracking, and the device data. The names are cleaned and only variables relating to quality and customer attributes are selected. The newly added variable "skin_tone" divides the users to different skin tone categories depending on their selected emoji modifier.

### Exploratory Plots

```{r}
race_sleep_data <- read.csv("./data/race_sleep_data.csv")
skin_tone_palette <- c("#ffdbac", "#f1c27d", "#e0ac69", "#c68642", "#8d5524")

race_sleep_data <- race_sleep_data %>%
  mutate(skin_tone = fct_relevel(skin_tone, "light", "medium_light", "medium", "medium_dark", "dark"))

race_sleep_data$sex <- ifelse(is.na(race_sleep_data$sex), "Not Answered", race_sleep_data$sex)
```

```{r}
# distribution of number of flags for each race 
race_fig_1 <- race_sleep_data %>% ggplot(aes(x = flags, fill=skin_tone)) + geom_histogram(bins = 30) + scale_fill_manual(values = skin_tone_palette) + facet_wrap("skin_tone") + theme_minimal() + 
  labs(title = "Distribution of Flags for each Skin Tone",
       x = "Number of Flags",
       y = "Count") + theme(legend.position="none") + theme(text = element_text(size = 6))


# number of individuals using each line for each race by sex

race_fig_2 <- race_sleep_data %>% ggplot(aes(line, fill = skin_tone)) + facet_wrap("sex") + geom_bar() + scale_fill_manual(values = skin_tone_palette) + theme_minimal() +
  labs(title = "Num of Users using each Line, sort by Sex and Skin Tone", 
       x = "Line",
       y = "Number of Users") + theme(legend.position="none") + theme(text = element_text(size = 6))

# number of flags v.s. duration, coloured by skin tone
race_fig_3 <- race_sleep_data %>% ggplot(aes(x = duration, y = flags, colour = skin_tone)) + geom_point()+ scale_colour_manual(values = skin_tone_palette) + theme_minimal() + 
  labs(title = "Sleep Duration v.s. Number of Flags, coloured by Skin Tone", 
       x = "Sleep Duration",
       y = "Number of Flags") + theme(legend.position="none") + theme(text = element_text(size = 6))
```

```{r, include = TRUE, echo = FALSE}
ggarrange(race_fig_2, ggarrange(race_fig_1, race_fig_3, labels = c("B", "C"), ncol = 1, nrow = 2), labels = c("A"))
```

Figure A shows that there are more light skinned users than dark skinned users and there are more females than males and intersex users. Most users use the Advance or Run lines.

Figure B shows that darker skinned users seem to have a larger spread and larger mean of number of flags than compared to lighter skinned users, suggesting some evidence of a performance bias.

Figure C shows that there is not much relationship between duration of sleep and number of flags, indicating that duration may not be an important predictor for the number of flags.

## Fitting a GLMM with Poisson Link Function
### Model Assumption Checks
1.  Independence of Subjects: the independence of subjects assumption is satisfied as we assume that every customer is independent from each other and are randomly selected from the population
2.  Random Effects (each individual) come from a normal distribution
3.  Random Effect errors have constant variance: 
```{r, include = TRUE, echo = FALSE, message=FALSE}
temp_race_sleep_data <- race_sleep_data %>% 
  filter(!(flags == 0)) %>% 
  group_by(cust_id) %>% 
  summarise("var" = var(log(flags)), "skin_tone" = skin_tone)


temp_race_sleep_data <- data.frame(temp_race_sleep_data)

temp_race_sleep_data %>% ggplot(aes(y = var)) + geom_boxplot() + scale_colour_manual(values = skin_tone_palette) + theme_minimal() + 
  labs(title = "Spread of the Variance of Log(# of flags) for each individual",
       y = "Var(Log(# of flags))") + theme(legend.position="none")
```
We see that the variance of the number of flags transformed by the link function (log) is mostly the same with little spread across individuals. This suggests that the homoscedasiticy of random effect errors assumption is satisfied.

4.  Poisson link function is appropriate:

From the Figure B above, we see that the number of flags (response variable) ranges from 0 to over 20, is right skewed, and can be modeled by Poisson distribution. We also check if the mean and variance of number of flags is equal for each skin tone:

```{r, include = TRUE, echo=FALSE}
# check mean and variance of number of flags for each skin tone (main effect)
mean_var_check <- race_sleep_data %>% group_by(skin_tone) %>% summarise(mean = mean(flags), var = var(flags), number= n())

mean_var_check <- data.frame(mean_var_check)

knitr::kable(mean_var_check, align = 'c', col.names = c("Skin Tone  ","  Mean(# of flags)  ", "  Var(# of flags)  ", "  Number of Observations"))
```
We do observe some evidence of a violation of the mean=variance assumption; however, any violations are modest. Hence, the Poisson model is appropriate in this case.

### Model Fitting

$$\begin{aligned}Y_{irs} &\thicksim Poisson(\lambda_{irs})\\
\log(\lambda_{irs}) &= \beta_0 + X_{irs}\beta + U_{i}\\
U_i &\thicksim N(0, \sigma ^2) 
\end{aligned}$$


- $Y_{irs}$ is the number of flags for individual $i$ with skin tone $r$ and sex $s$
- $X_{irs}$ has indicator variables for skin tone and sex
- $U_i$ is the individual level random effect

```{r}

race1<- lme4::glmer(flags ~ skin_tone + (1 | cust_id), 
        family='poisson', data=race_sleep_data)
#summary(race1)

race2<- lme4::glmer(flags ~ skin_tone + sex + (1 | cust_id), 
        family='poisson', data=race_sleep_data)

```

```{r, cache = TRUE, message=FALSE, include = TRUE, echo = FALSE}
ci <- confint(race2,parm="beta_",method="Wald")
expect_conf <- exp(ci)

expect_conf <- data.frame(expect_conf)

knitr::kable(expect_conf, align = 'c', col.names = c("2.5%", "97.5%"))

```
From the model, we see that the general trend is the darker one is, the higher the log of the mean number of flags their devices report. For example, compared to the base line of the light skin tone, we are 95% confident that, compared to light skinned users, the mean number of flags for a user with the dark skin tone changes by a factor of between (9.77, 10.65), which is about ten times more. The p-values for each level of skin tone predictors are extremely small, suggesting strong evidence against the fact that the mean number of flags are equal for different types of skin tones. We also observe that there is a (1 - 0.91) x 100% = 9% decrease in the mean number of flags for males compared to females; however, this result may just be due to the relatively fewer data for male users than for female users. 

## What are the main differences between different lines of the device?

In this research question, we are interested in the differences of the **performance/price** among the different lines of services, combined with the different demographic of the users between lines, we can give a report summary/advice for what has changed and how the change affects the target audience.

### Data Manipulation

We used three database in this part. The first one is ***device_data***, which is retrieved by web scraping from the fitness tracker info hub. This database includes all the information on the devices produced by the company *Mingar* and *Bitfit.* The second database is ***device_cust*** including the data for individuals who bought the devices from *Mingar.* This database is obtained by merging the database *cust_dev* and *customer*. The third database used in this question is ***data_performance,*** which includes the percentage of the devices having some functionality in each line***.*** This dataset is built by group the *device_data* by line and functionality. More details about the code of data waggling is in the *data_prep.Rmd* file.

### Exploratory plots

```{r}
device_data <- read.csv("./data/device_data.csv")
device_cust <- read.csv("./data/device_cust.csv")
device_performance <- read.csv("./data/device_performance.csv")
```

```{r echo=FALSE, include=TRUE, fig.height=5, fig.width=5}
# Other performance
library(ggpubr)
ggballoonplot(device_performance, 
              x="name", 
              y="line", 
              size = "percentage", 
              fill = "percentage",
              color = "percentage",
              ggtheme = theme_minimal()) +
  scale_fill_viridis_c(option = "E") +
  scale_color_viridis_c(option = "E")
```

The above plot shows the performance of different lines. The size of the circle is the percentage of devices in the line on x-axis that has the functionality on y-axis. Based on the plot, the line *Run* has all of the functionality, while line *Active* and *Advanced* has all except the pulse oximiter. By the size of each circle, the line *Run* has a more diverse functionality than the other two lines. Each device in line *Advanced* almost has the same functionality.

```{r fig.cap="Recommeded Retail price vs Released Date",  echo=FALSE}
p1 <- device_data %>%
  ggplot(aes(x = released_yr, y = recommended_retail_price, color = line, shape = brand)) +
  geom_point(size = 2) +
  scale_color_brewer(palette="Set3") +
  labs(x = "Released Year",
       y = "Price") +
  theme(text = element_text(size = 15))+
  theme_minimal()
```

```{r eval=FALSE, include=FALSE}
mingar <-  device_data %>% 
              na.omit() %>% 
              filter(brand == "Mingar") %>% 
              summarise(mean=mean())
mean(mingar$recommended_retail_price)
bitfit <-  device_data %>% 
              na.omit() %>% 
              filter(brand == "Bitfit") %>% 
              select(recommended_retail_price)
mean(bitfit$recommended_retail_price)
```

```{r echo=FALSE}
# device_data %>% 
#   ggplot(aes(y = released_yr, color = line, fill = line)) +
#   geom_bar(stat="count") +
#   scale_color_brewer(palette="Set3") +
#   scale_fill_brewer(palette="Set3") +
#   labs(title = "Number of realesed products vs Released Year", 
#        y = "Released Year",
#        x = "Number of Reealsed products",
#        caption = "Created by Mango in 2022") +
#   theme_minimal()
```

```{r fig.cap="Number of realesed products vs Batttery Life", echo=FALSE}
# Batterty Lives
p2 <- device_data %>% 
  ggplot(aes(y = battery_life, color = line, fill = line)) +
  geom_bar(stat="count") +
  scale_color_brewer(palette="Set3") +
  scale_fill_brewer(palette="Set3") +
  labs(x = "Released Year",
       y = "Battery Life") +
  theme_minimal()
```

```{r}
# Waterproof
p3<-device_data %>% 
  ggplot(aes(y = water_resitance, color = line, fill = line)) +
  geom_bar(stat="count") +
  scale_color_brewer(palette="Set3") +
  scale_fill_brewer(palette="Set3") +
  labs(x = "Released Year",
       y = "Waterproof") +
  theme_minimal()
```

```{r}
p4<-device_cust %>% 
  ggplot(aes(y=line))+
  geom_bar() +
  labs(x = "Sales",
       y = "Line",
       caption = "Created by Mango in 2022")
```

```{r echo=FALSE, include=TRUE}
ggarrange(p1, p2, p3, p4,
          labels = c("A", "B", "C", "D"),
          common.legend = TRUE, 
          legend = "bottom",
          ncol = 2, nrow = 2)
```

**Plot A** above is a scatter plot showing the recommended retail price, released year and the lines. According to the plot, the line *Run* has the highest price in the range of \$300 - \$500, while line *Advanced* and *Active* has a much lower price from \$50 to \$150. The average price of all lines in *Mingar* is \$284.66. And the average price of all lines in *Bitfit* is \$180.90. By the plot A, the released year for the line *Run* is spread through the x-axis, while the line *Advanced* and *Active* only came out in the most recent 3 years.

**Plot B** is a bar chart showing the battery life for each line. Based on the plot, we noticed that line *Run* usually has the longest battery life, since most of the devices of *Run* has a battery life up to 14 days and more. However, the battery life of line *Advanced* and *Active* is shorter, which is about 5-14 days.

**Plot C** is a also a bar chart showing the performance of waterproof. Line *Run* has a better waterproof performance, all devices from *Run* has a waterproof of 5ATM-10ATM, while devices from line *Advanced* and *Active* are only water resistant, which is the lowest level of waterproof.

**Plot D** shows the popularity of each line in *Mingar*. From the bar chart, we can conclude that the line *Run* and *Advanced* are the two most popular line in *Mingar.* And the sales of *Run* is slightly greater than *Advanced.*

### Conclusions

Above all, we noticed that the line *Run* and *Advanced* are the most popular lines at *Mingar.* Line *Run* has an overall better performance and a higher price among all other lines. Run is one of the earliest lines the company started producing, thus, line *Run* has 9 devices, which is the line having most products. Line *Active* and *Advanced* are two new lines that came out in the most recent 3 years. There are only 5 devices for the line *Advanced* and *Active.* However, the total sales of line *Advanced* and *Active* is more than that of line *Run.* The result implies that when the devices with sufficient functionality, price is the major factor for number of sales.

## Discussion

*In this section you will summarize your findings across all the research questions and discuss the strengths and limitations of your work. It doesn't have to be long, but keep in mind that often people will just skim the intro and the discussion of a document like this, so make sure it is useful as a semi-standalone section (doesn't have to be completely standalone like the executive summary).*

### Strengths and limitations

\newpage

# Consultant information

## Consultant profiles

*Complete this section with a brief bio for each member of your group. If you are completing the project individually, you only need to complete one for yourself. In that case, change the title of this section to 'Consultant profile' instead. Examples below. This section is only marked for completeness, clarity and professionalism, not 'truth' so you can write it as if we're a few years in the future. Put your current degree in as completed and/or add your first choice grad school program, whatever you like. What skills related skills would you most like to highlight? What job title do you want?*

**Statsy McStatsstats**. Statsy is a senior consultant with Eminence Analytics. She specializes in data visualization. Statsy earned her Bachelor of Science, Specialist in Statistics Methods and Practice, from the University of Toronto in 2023.

**Datana Scatterplot**. Datana is a junior consultant with Eminence Analytics. They specialize in reproducible analysis and statistical communication. Datana earned their Bachelor of Science, Majoring in Computer Science and Statistics from the University of Toronto in 2024.

## Code of ethical conduct

*This section should be fairly short, no more than half a page. Assume a general audience, much like your executive summary.*

-   *Make at least three relevant statements about your company's approach to ethical statistical consulting. These should be appropriately in line with professional conduct advice like the (Statistical Society of Canada Code of Conduct)[<https://ssc.ca/sites/default/files/data/Members/public/Accreditation/ethics_e.pdf>] or the (Ethical Guidelines for Statistical Practice from the American Statistical Society)[<https://www.amstat.org/ASA/Your-Career/Ethical-Guidelines-for-Statistical-Practice.aspx>]. For example, "the customer is always right" ISN'T the type of thing an ethical statistical consultant would include.*
-   *Be very careful not to just copy and paste from these other documents! Put things in your own words.*

\newpage

# References

*You don't need to cite course materials, but consider all the the places you got data from, as well as the packages used and R itself. These are all things you should consider citing. Likewise, you might use some external resources on the emoji skin tones/Fitzpatrick scale, etc.*

\newpage

# Appendix

*These appendices should outline in more detail the steps taken to access the following datasets. They should NOT include code, but should briefly describe the steps and important considerations. I.e., show that you understand what needs to be considered when web scraping, protecting licensed data, etc.*

## Web scraping industry data on fitness tracker devices

## Accessing Census data on median household income

## Accessing postcode conversion files

**Final advice: KNIT EARLY AND OFTEN!**
