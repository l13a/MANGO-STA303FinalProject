---
title: "Report Title"
subtitle: "Subtitle that indicates findings"
author: "Report prepared for MINGAR by [MANGO]"
date: 2022-04-07
lang: "en"
output:
  pdf_document:
    template: report.tex
    toc: true
    toc_depth: 2
    
titlepage: true
titlepage-color: "6C3082"
titlepage-text-color: "FFFFFF"
titlepage-rule-color: "FFFFFF"
titlepage-rule-height: 2
---

```{r, message = FALSE, echo=FALSE}
library(tidyverse)
library(lme4)
library(rvest)
library(polite)
library(lmtest)
library(wesanderson)
library(ggplot2)
library(gplots)
library(ggmap)
library(maps)
library(mapdata)
library(leaflet)
library(plotly)
library(RColorBrewer)

# this should suppress all code and messages
knitr::opts_chunk$set(include=FALSE)
```

# General comments (you can delete this section)

*Before making any changes, knit this Rmd to PDF and change the name of the PDf to something like 'original-instructions.pdf', or whatever you like (it is just for your reference).. Then you can delete this section and if you want to check what it said, just open the other PDF. You don't HAVE to use this particular template, but you DO need to write you report in RMarkdown and include a cover page.*

*The cover page must be a single stand alone page and have:*

-   *A title and subtitle (that indicate your findings)*
-   *"Report prepared for MINGAR by" your company name*
-   *Date (assessment submission date is fine)*

*You can change the colour of this cover to any colour you would like by replacing 6C3082 in the YAML above (`titlepage-color:`) to another hex code. You could use this tool to help you:* <https://htmlcolorcodes.com/color-picker/>

*Note: There should NOT be a table of contents on the cover page. It should look like a cover.*

\newpage

# Executive summary

*Guidelines for the executive summary:*

-   *No more than two pages*
-   *Language is appropriate for a non-technical audience*
-   *Bullet points are used where appropriate*
-   *A small number of key visualizations and/or tables are included*
-   *All research questions are addressed*

*The [module 4 writing prompt](https://sta303-bolton.github.io/sta303-w22-courseguide/knowledge-basket-writing-and-peer-feedback.html#module-4-writing-task) provides some tips and information about writing executive summaries.*

\newpage

# Technical report

*This part of the report is much more comprehensive than the executive summary. The audience is statistics/data-minded people, but you should NOT include code or unformatted R output here.*

## Introduction

*Provide a brief introduction to your report and outline what the report will cover. This section is valuable for setting scope and expectations.*

### Research questions

-   How do the demographic for the traditional lines compare with that of the "Active and "Advance" lines?

-   Are the devices "racist"?

-   What are the main differences between different lines of the device?

## How do the demographic for the traditional lines compare with that of the "Active and "Advance" lines?

*For each research question, you will want to briefly describe any data manipulation, show some exploratory plots/summary tables, report on any methods you use (i.e. models you fit) and the conclusions you draw from these*

```{r}
device_cust <-read.csv("./data/device_cust.csv")
```

```{r fig.cap="Age of customer by device line", include=T, echo=F}

device_cust %>% ggplot(aes(x = age, fill=line)) + geom_histogram(bins = 30) +  facet_wrap("line")  + scale_color_brewer(palette="Set3")
# + scale_fill_manual(values = wes_palette("Moonrise3"))
```

```{r}
province <- c(10, 11, 12, 13, 24, 35, 46, 47, 48, 59, 60, 61, 62)
province_name <- c("Newfoundland and Labrador", "Prince Edward Island","Nova Scotia", "New Brunswick", "Quebec", "Ontario", "Manitoba", "Saskatchewan", "Alberta", "British Columbia", "Yukon", "Northwest Territories", "Nunavut")
latitude <- c(53.5, 46, 45, 46.498390, 53, 50, 56.415211, 55, 55, 53.726669, 64, 62.135189, 70.453262)
longtitude <- c(-60, -63, -63, -66.159668, -70, -85,-98.739075, -106, -115, -127.647621, -135, -122.792473, -86.798981)
canada_pro<- data.frame(province = province, province_name = province_name, latitude=latitude,longtitude= longtitude)

device_cust$province <- substr(device_cust$CSDuid,1,2)
device_cust <- merge(device_cust, canada_pro, by="province")
province_data <- device_cust %>% group_by(province, line) %>% summarise(num = n(), province_name, latitude, longtitude) %>% unique()

province_data_active <- province_data[province_data$line == "Active",]
province_data_advance <- province_data[province_data$line == "Advance",]
province_data_run <- province_data[province_data$line == "Run",]
province_data_idol <- province_data[province_data$line == "iDOL",]
```

```{r include=F}
# province_data_active %>% 
#   plot_ly(x=~longtitude, y=~latitude, type="scatter", mode = "hover", color= ~province_name, size=~num, sizes = c(20, 200),  marker=list(sizemode="diameter", opacity=0.5)) %>% layout(title="Active")
# 
# province_data_advance %>%
#   plot_ly(x=~longtitude, y=~latitude, type="scatter", mode = "hover", color= ~province_name, size=~num, sizes = c(20, 200),  marker=list(sizemode="diameter", opacity=0.5)) %>% layout(title="Advance")
# 
# province_data_run %>% 
#   plot_ly(x=~longtitude, y=~latitude, type="scatter", mode = "hover", color= ~province_name, size=~num, sizes = c(20, 200),  marker=list(sizemode="diameter", opacity=0.5))%>% layout(title="Run")
# 
# province_data_idol %>%
#   plot_ly(x=~longtitude, y=~latitude, type="scatter", mode = "hover", color= ~province_name, size=~num, sizes = c(20, 200),  marker=list(sizemode="diameter", opacity=0.5))%>% layout(title="iDOL")

```

![Customer location by device line](./data/province_line.png)

```{r}
device_cust$sex_binary <-  as.factor(ifelse(device_cust$sex == "Female", 0,
                        ifelse(device_cust$sex == "Male", 1, NaN)))
mod <- glm(sex_binary ~ line, 
  family=binomial(link='logit'), data=device_cust, na.action =  na.exclude)
```

```{r}
device_cust$age_range <-  as.factor(ifelse(device_cust$age <= 12, "children",
                        ifelse(device_cust$age <= 18, "teenager",
                        ifelse(device_cust$age <= 59, "adult","senior adult"))))
kruskal.test(age_range ~ line, data = device_cust)
```

### Kruskal-Wallis test for median income vs lines

```{r}
income <-  read.csv("./data/median_income.csv")
device_cust <- read.csv("./data/device_cust.csv")
group_income <- inner_join(device_cust, income) %>% select(c("line", "hhld_median_inc"))

group_income %>% 
  ggplot(aes(x= hhld_median_inc)) + 
  geom_histogram(bins = 30) + 
  facet_wrap("line")+
  labs(title = "Median Income vs Count by Lines", 
       x = "Median Income",
       y = "Count",
       caption = "Created by Mango in 2022")

kruskal.test(hhld_median_inc ~ line, data = group_income)
```

-   The response is the median income, which is a categorical parameter

-   The predictor is the lines, which is also a categorical parameter

-   Conclusion: the p-values is extremely small, thus, we can conclude that the distributions for these 4 lines is different

```{r}
income <-  read.csv("./data/median_income.csv")
group_income <- inner_join(device_cust, income) %>% select(c("line", "hhld_median_inc"))

group_income %>% ggplot(aes(x= hhld_median_inc)) + geom_histogram() + facet_wrap("line")
mod <- lm(hhld_median_inc ~ line, data = group_income)
summary(mod)

summary(aov(hhld_median_inc ~ line, data = group_income))
```

## How does race affect the accuracy of wearable devices?

```{r}
race_sleep_data <- read.csv("./data/race_sleep_data.csv")
skin_tone_palette <- c("#ffdbac", "#f1c27d", "#e0ac69", "#c68642", "#8d5524")

race_sleep_data <- race_sleep_data %>%
  mutate(skin_tone = fct_relevel(skin_tone, "light", "medium_light", "medium", "medium_dark", "dark"))
```

```{r}
# total number of individuals for each race
race_sleep_data %>% ggplot(aes(skin_tone, fill = skin_tone)) + geom_bar() + scale_fill_manual(values = skin_tone_palette) +theme_minimal()

race_sleep_data %>% group_by(skin_tone) %>% summarise(count = n())
```

```{r}
# distribution of number of flags for each race 
race_sleep_data %>% ggplot(aes(x = flags, fill=skin_tone)) + geom_histogram(bins = 30) + scale_fill_manual(values = skin_tone_palette) + facet_wrap("skin_tone") + theme_linedraw()
```

```{r}
# number of individuals using each line for each race by sex
race_sleep_data %>% ggplot(aes(line, fill = skin_tone)) + facet_wrap("sex") + geom_bar() + scale_fill_manual(values = skin_tone_palette) + theme_minimal()

# race_sleep_data %>% ggplot(aes(sex, fill = skin_tone)) + geom_bar() + scale_fill_manual(values = skin_tone_palette) + theme_minimal()
```

```{r}
# number of flags for whether there is a pulse oximiter, coloured by skin tone
race_sleep_data %>% ggplot(aes(x = flags, fill = skin_tone)) + scale_fill_manual(values = skin_tone_palette)+ geom_histogram(bins = 30) + facet_wrap("pulse_oximiter") + theme_linedraw()
```

```{r}
# number of flags for each battery_life, coloured by skin tone
race_sleep_data %>% ggplot(aes(x = flags, fill = skin_tone)) + scale_fill_manual(values = skin_tone_palette)+ geom_histogram(bins = 30) + facet_wrap("battery_life") + theme_linedraw()

```

```{r}
# number of flags for each water resistence type, coloured by skin tone
race_sleep_data %>% ggplot(aes(x = flags, fill = skin_tone)) + scale_fill_manual(values = skin_tone_palette)+ geom_histogram(bins = 30) + facet_wrap("water_resitance") + theme_linedraw()
```

```{r}
# number of flags v.s. duration, coloured by skin tone
race_sleep_data %>% ggplot(aes(x = duration, y = flags, colour = skin_tone)) + geom_point()+ scale_colour_manual(values = skin_tone_palette) + theme_linedraw()

```

```{r}
race_sleep_data %>% ggplot(aes(x = cust_id, y = flags)) + geom_point() + theme_linedraw()
```

```{r}
temp_race_sleep_data <- race_sleep_data %>% group_by(cust_id) %>% mutate(mean = mean(flags)) %>% mutate(var = var(flags))

temp_race_sleep_data %>% ggplot(aes(x = mean, y = var, colour = skin_tone)) + geom_point()+ scale_colour_manual(values = skin_tone_palette) + theme_linedraw()

```

Observations: - more light skinned individuals than dark skinned individuals

-   darker skinned individuals seem to have a larger spread and larger mean of number of flags than compared to lighter skinned individuals

-   more females than males wearing devices (might need to do this in a different dataset)

-   most individuals wear the Advance or Run line

-   battery life, water resistance, and whether or not there is a pulse oximiter seem to not affect the number of flags

-   not much relationship between duration of sleep and number of flags

### Model Assumption Checks

1.  Independence of Subjects: the independence of subjects assumption is satisfied as we assume that every customer is independent from each other and are randomly selected from the population.

2.  Random Effects come from a normal distribution ????

3.  Random Effect errors have constant variance

```{r}
  
temp_race_sleep_data <- race_sleep_data %>% 
  filter(!(flags == 0)) %>% 
  group_by(skin_tone) %>% 
  summarise(var_of_log_flags = var(log(flags)))

temp_race_sleep_data
```

We see that the variance of the number of flags transformed by the link function (log) is homogeneous across skin tones. This suggests that the homoscedasiticy of random effect errors assumption is satisfied

4.  Poisson link function is appropriate:

```{r}
# check distribution of response variable
race_sleep_data %>% ggplot(aes(flags, fill = skin_tone)) + geom_histogram(bins = 30) + scale_fill_manual(values = skin_tone_palette) +theme_minimal()
```

From the plot, we see that the number of flags (response variable) is ranges from 0 to over 20, is right skewed, and can be modeled by Poisson distribution.

```{r}
# check mean and variance of number of flags for each skin tone (main effect)
race_sleep_data %>% group_by(skin_tone) %>% dplyr::summarize(mean = mean(flags), var = var(flags), n= n())
```

We do observe some evidence of a violation of the mean=variance assumption; however, any violations are modest. Hence, the Poisson model is appropriate in this case.

Check that log(response) is a linear function of the predictor???

### GLMM Model Fitting

```{r}
race_sleep_data <- race_sleep_data %>% filter(!is.na(sex))

race1<- lme4::glmer(flags ~ skin_tone + (1 | cust_id), 
        family='poisson', data=race_sleep_data)
summary(race1)

race2<- lme4::glmer(flags ~ skin_tone + sex + (1 | cust_id), 
        family='poisson', data=race_sleep_data)
summary(race2)

# race3<- glm(flags ~ skin_tone + sex + line, 
#        family='poisson', data=race_sleep_data)
# summary(race3)

lmtest::lrtest(race1, race2)
```

Likelihood Ratio Test shows that we have significant evidence (p value = 5.49e-07) against the fact that the simpler model explains the data just as well as the complex model. Hence, we prefer race2 over race1. From race2, INTERPRET THE MODEL HEREEE

\newpage

## What are the main differences between different lines of the device?

In this research question, we are interested in the differences of the **performance/price** among the different lines of services, combined with the different demographic of the users between lines, we can give a report summary/advice for what has changed and how the change affects the target audience.

### Data Manipulation

We used three database in this part. The first one is ***device_data***, which is retrieved by web scraping from the fitness tracker info hub. This database includes all the information on the devices produced by the company *Mingar* and *Bitfit.* The second database is ***device_cust*** including the data for individuals who bought the devices from *Mingar.* This database is obtained by merging the database *cust_dev* and *customer*. The third database used in this question is ***data_performance,*** which includes the percentage of the devices having some functionality in each line***.*** This dataset is built by group the *device_data* by line and functionality. More details about the code of data waggling is in the *data_prep.Rmd* file.

### 
Exploratory plots

```{r}
device_data <- read.csv("./data/device_data.csv")
device_cust <- read.csv("./data/device_cust.csv")
device_performance <- read.csv("./data/device_performance.csv")
```

```{r echo=FALSE, include=TRUE}
# Other performance
library(ggpubr)
ggballoonplot(device_performance, 
              x="line", 
              y="name", 
              size = "percentage", 
              fill = "percentage",
              color = "percentage") +
  scale_fill_viridis_c(option = "E") +
  scale_color_viridis_c(option = "E")
```

The above plot shows the performance of different lines. The size of the circle is the percentage of devices in the line on x-axis that has the functionality on y-axis. Based on the plot, the line *Run* has all of the functionality, while line *Active* and *Advanced* has all except the pulse oximiter. By the size of each circle, the line *Run* has a more diverse functionality than the other two lines. Each device in line *Advanced* almost has the same functionality.

```{r fig.cap="Recommeded Retail price vs Released Date",  echo=FALSE}
p1 <- device_data %>%
  ggplot(aes(x = released_yr, y = recommended_retail_price, color = line, shape = brand)) +
  geom_point(size = 2) +
  scale_color_brewer(palette="Set3") +
  labs(x = "Released Year",
       y = "Price") +
  theme(text = element_text(size = 15))+
  theme_minimal()
```

```{r eval=FALSE, include=FALSE}
mingar <-  device_data %>% 
              na.omit() %>% 
              filter(brand == "Mingar") %>% 
              summarise(mean=mean())
mean(mingar$recommended_retail_price)

bitfit <-  device_data %>% 
              na.omit() %>% 
              filter(brand == "Bitfit") %>% 
              select(recommended_retail_price)
mean(bitfit$recommended_retail_price)
```

```{r echo=FALSE}
# device_data %>% 
#   ggplot(aes(y = released_yr, color = line, fill = line)) +
#   geom_bar(stat="count") +
#   scale_color_brewer(palette="Set3") +
#   scale_fill_brewer(palette="Set3") +
#   labs(title = "Number of realesed products vs Released Year", 
#        y = "Released Year",
#        x = "Number of Reealsed products",
#        caption = "Created by Mango in 2022") +
#   theme_minimal()
```

```{r fig.cap="Number of realesed products vs Batttery Life", echo=FALSE}
# Batterty Lives
p2 <- device_data %>% 
  ggplot(aes(y = battery_life, color = line, fill = line)) +
  geom_bar(stat="count") +
  scale_color_brewer(palette="Set3") +
  scale_fill_brewer(palette="Set3") +
  labs(x = "Released Year",
       y = "Battery Life") +
  theme_minimal()
```

```{r}
# Waterproof
p3<-device_data %>% 
  ggplot(aes(y = water_resitance, color = line, fill = line)) +
  geom_bar(stat="count") +
  scale_color_brewer(palette="Set3") +
  scale_fill_brewer(palette="Set3") +
  labs(x = "Released Year",
       y = "Waterproof") +
  theme_minimal()
```

```{r}
p4<-device_cust %>% 
  ggplot(aes(y=line))+
  geom_bar() +
  labs(x = "Sales",
       y = "Line",
       caption = "Created by Mango in 2022")
```

```{r echo=FALSE, include=TRUE}
ggarrange(p1, p2, p3, p4,
          labels = c("A", "B", "C", "D"),
          common.legend = TRUE, 
          legend = "bottom",
          ncol = 2, nrow = 2)
```

**Plot A** above is a scatter plot showing the recommended retail price, released year and the lines. According to the plot, the line *Run* has the highest price in the range of \$300 - \$500, while line *Advanced* and *Active* has a much lower price from \$50 to \$150. The average price of all lines in *Mingar* is \$284.66. And the average price of all lines in *Bitfit* is \$180.90. By the plot A, the released year for the line *Run* is spread through the x-axis, while the line *Advanced* and *Active* only came out in the most recent 3 years.

**Plot B** is a bar chart showing the battery life for each line. Based on the plot, we noticed that line *Run* usually has the longest battery life, since most of the devices of *Run* has a battery life up to 14 days and more. However, the battery life of line *Advanced* and *Active* is shorter, which is about 5-14 days.

**Plot C** is a also a bar chart showing the performance of waterproof. Line *Run* has a better waterproof performance, all devices from *Run* has a waterproof of 5ATM-10ATM, while devices from line *Advanced* and *Active* are only water resisrant, which is the lowest level of waterproof.

**Plot D** shows the popularity of each line in *Mingar*. From the bar chart, we can conclude that the line *Run* and *Advanced* are the two most popular line in *Mingar.* And the sales of *Run* is slightly greater than *Advanced.*

### Conclusions

Above all, we noticed that the line *Run* and *Advanced* are the most popular lines at *Mingar.* Line *Run* has an overall better performance and a higher price among all other lines. Run is one of the earliest lines the company started producing, thus, line *Run* has 9 devices, which is the line having most products. Line *Active* and *Advanced* are two new lines that came out in the most recent 3 years. There are only 5 devices for the line *Advanced* and *Active.* However, the total sales of line *Advanced* and *Active* is more than that of line *Run.* The result implies that when the devices with sufficient functionality, price is the major factor for number of sales.

## Discussion

*In this section you will summarize your findings across all the research questions and discuss the strengths and limitations of your work. It doesn't have to be long, but keep in mind that often people will just skim the intro and the discussion of a document like this, so make sure it is useful as a semi-standalone section (doesn't have to be completely standalone like the executive summary).*

### Strengths and limitations

\newpage

# Consultant information

## Consultant profiles

*Complete this section with a brief bio for each member of your group. If you are completing the project individually, you only need to complete one for yourself. In that case, change the title of this section to 'Consultant profile' instead. Examples below. This section is only marked for completeness, clarity and professionalism, not 'truth' so you can write it as if we're a few years in the future. Put your current degree in as completed and/or add your first choice grad school program, whatever you like. What skills related skills would you most like to highlight? What job title do you want?*

**Statsy McStatsstats**. Statsy is a senior consultant with Eminence Analytics. She specializes in data visualization. Statsy earned her Bachelor of Science, Specialist in Statistics Methods and Practice, from the University of Toronto in 2023.

**Datana Scatterplot**. Datana is a junior consultant with Eminence Analytics. They specialize in reproducible analysis and statistical communication. Datana earned their Bachelor of Science, Majoring in Computer Science and Statistics from the University of Toronto in 2024.

## Code of ethical conduct

*This section should be fairly short, no more than half a page. Assume a general audience, much like your executive summary.*

-   *Make at least three relevant statements about your company's approach to ethical statistical consulting. These should be appropriately in line with professional conduct advice like the (Statistical Society of Canada Code of Conduct)[<https://ssc.ca/sites/default/files/data/Members/public/Accreditation/ethics_e.pdf>] or the (Ethical Guidelines for Statistical Practice from the American Statistical Society)[<https://www.amstat.org/ASA/Your-Career/Ethical-Guidelines-for-Statistical-Practice.aspx>]. For example, "the customer is always right" ISN'T the type of thing an ethical statistical consultant would include.*
-   *Be very careful not to just copy and paste from these other documents! Put things in your own words.*

\newpage

# References

*You don't need to cite course materials, but consider all the the places you got data from, as well as the packages used and R itself. These are all things you should consider citing. Likewise, you might use some external resources on the emoji skin tones/Fitzpatrick scale, etc.*

\newpage

# Appendix

*These appendices should outline in more detail the steps taken to access the following datasets. They should NOT include code, but should briefly describe the steps and important considerations. I.e., show that you understand what needs to be considered when web scraping, protecting licensed data, etc.*

## Web scraping industry data on fitness tracker devices

## Accessing Census data on median household income

## Accessing postcode conversion files

**Final advice: KNIT EARLY AND OFTEN!**
